___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Spotify Server-side",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Stape",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Spotify Pixel for Server-side Google Tag Manager",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixel_id",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Copy the numeric value found on Manage \u003e Your Pixels"
  },
  {
    "type": "TEXT",
    "name": "session_id",
    "displayName": "Session ID",
    "simpleValueType": true,
    "help": "A hashed session ID. This enables us to distinguish multiple events by the same visitor.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "action",
    "displayName": "Pixel type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "init",
        "displayValue": "Page View"
      },
      {
        "value": "lead",
        "displayValue": "Lead"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "init",
    "help": "Defines the conversion event type"
  },
  {
    "type": "GROUP",
    "name": "initGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "init_alias",
        "displayName": "Alias",
        "simpleValueType": true,
        "help": "Your internal user ID for matching across subdomains",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "init",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "leadGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "lead_type",
        "displayName": "Lead Type",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "lead_value",
        "displayName": "Lead category",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "lead",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "purchaseGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "purchase_value",
        "displayName": "Numerical purchase value",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "purchase_currency",
        "displayName": "Currency",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "purchase_order_id",
        "displayName": "Order ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "action",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "useOptimisticScenario",
    "checkboxText": "Use Optimistic Scenario",
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not."
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "displayName": "",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const getContainerVersion = require('getContainerVersion');
const logToConsole = require('logToConsole');
const getRequestHeader = require('getRequestHeader');
const encodeUriComponent = require('encodeUriComponent');
const Object = require('Object');

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = getRequestHeader('trace-id');

sendTrackRequest();

function sendTrackRequest() {
  let host = 'https://img.byspotify.com';
  const params = getRequestParams();
  const queryString = mapParamsToQueryString(params);
  const url = host + '?' + queryString;
  const headers = getRequestHeaders();

  if (isLoggingEnabled) {
    logToConsole(
      JSON.stringify({
        Name: 'Spotify',
        Type: 'Request',
        TraceId: traceId,
        EventName: params.a,
        RequestMethod: 'GET',
        RequestUrl: url,
        RequestHeaders: headers,
      })
    );
  }
  sendHttpRequest(
    url,
    (statusCode, headers, body) => {
      if (isLoggingEnabled) {
        logToConsole(
          JSON.stringify({
            Name: 'Spotify',
            Type: 'Response',
            TraceId: traceId,
            EventName: params.a,
            ResponseStatusCode: statusCode,
            ResponseHeaders: headers,
            ResponseBody: body,
          })
        );
      }
      if (!data.useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    },
    {
      headers: headers,
    }
  );

  if (data.useOptimisticScenario) {
    data.gtmOnSuccess();
  }
}

function getRequestParams() {
  const params = {
    key: data.pixel_id,
    uid: data.session_id,
    a: data.action,
  };
  const paramMappers = {
    init: addInitParams,
    lead: addLeadParams,
    purchase: addPurchaseParams,
  };
  const paramMapper = paramMappers[params.action];
  if (paramMapper) paramMapper(params);
  return params;
}

function addInitParams(params) {
  params.alias = data.init_alias;
}

function addLeadParams(params) {
  params.type = data.lead_content_type;
  params.value = data.lead_value;
}

function addPurchaseParams(params) {
  params.currency = data.purchase_currency;
  params.value = data.purchase_value;
  params.order_id = data.purchase_order_id;
}

function getRequestHeaders() {
  return {
    'X-Forwarded-For': getRequestHeader('X-Forwarded-For'),
    UserAgent: getRequestHeader('User-Agent'),
    Referer: getRequestHeader('Referer'),
  };
}

function mapParamsToQueryString(params) {
  return Object.keys(params)
    .map((key) => key + '=' + encodeUriComponent(params[key]))
    .join('&');
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://img.byspotify.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "remoteAddressAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 02/05/2021, 09:39:23


